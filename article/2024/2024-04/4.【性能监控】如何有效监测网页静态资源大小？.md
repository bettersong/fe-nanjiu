## å‰è¨€

ä½œä¸ºå‰ç«¯äººå‘˜è‚¯å®šç»å¸¸é‡åˆ°è¿™æ ·çš„åœºæ™¯ï¼šéœ€æ±‚åˆšä¸Šçº¿ï¼Œäº§å“æ‹¿ç€æ‰‹æœºæ¥æ‰¾ä½ ï¼Œä¸ºä»€ä¹ˆé¡µé¢æ‰“å¼€è¿™ä¹ˆæ…¢å‘€ï¼Œå¿ƒæƒ³è‡ªå·±å¼€å‘çš„æ—¶å€™ä¹Ÿæœ‰æ³¨æ„æ€§èƒ½é—®é¢˜å‘€ï¼Œä¸å¯èƒ½ä¼šè¿™ä¹ˆå¤¸å¼ ã€‚é‚£æ²¡åŠæ³•åªèƒ½æ’æŸ¥ä¸‹æ˜¯å“ªä¸€å—å½±å“äº†é¡µé¢çš„æ•´ä½“æ€§èƒ½ï¼Œæ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ä¸€çœ‹ï¼Œé¡µé¢ä¸Šçš„è¿™äº›é…å›¾æ¯å¼ éƒ½éå¸¸å¤§ï¼Œå¿ƒæƒ³è¿™äº›é…å›¾éƒ½è¿™ä¹ˆå¤§ï¼Œé¡µé¢æ€ä¹ˆå¿«ï¼Œé‚£ä¹ˆæˆ‘ä»¬æœ‰æ²¡æœ‰åŠæ³•ç›‘æµ‹é¡µé¢ä¸Šçš„è¿™äº›é™æ€èµ„æºå¤§å°ï¼Œä»è€Œé¿å…è¿™ç§æƒ…å†µçš„å‘ç”Ÿã€‚

## Performance

**`Performance`** æ¥å£å¯ä»¥è·å–åˆ°å½“å‰é¡µé¢ä¸­ä¸æ€§èƒ½ç›¸å…³çš„ä¿¡æ¯ã€‚

è¯¥å¯¹è±¡æä¾›è®¸å¤šå±æ€§åŠæ–¹æ³•å¯ä»¥ç”¨æ¥æµ‹é‡é¡µé¢æ€§èƒ½ï¼Œè¿™é‡Œä»‹ç»å‡ ä¸ªç”¨æ¥è·å–`PerformanceEntry`çš„æ–¹æ³•ï¼š

### getEntries

> è¯¥æ–¹æ³•è·å–ä¸€ç»„å½“å‰é¡µé¢å·²ç»åŠ è½½çš„èµ„æº**PerformanceEntry**å¯¹è±¡ã€‚æ¥æ”¶ä¸€ä¸ªå¯é€‰çš„å‚æ•°`options`è¿›è¡Œè¿‡æ»¤ï¼Œ`options`æ”¯æŒçš„å±æ€§æœ‰`name`ï¼Œ`entryType`ï¼Œ`initiatorType`ã€‚

```js
const entries = window.performance.getEntries();
```

### getEntriesByName

> è¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªç»™å®šåç§°å’Œ name å’Œ type å±æ€§çš„`PerformanceEntry`å¯¹è±¡æ•°ç»„ï¼Œ`name`çš„å–å€¼å¯¹åº”åˆ°èµ„æºæ•°æ®ä¸­çš„`name`å­—æ®µï¼Œ`type`å–å€¼å¯¹åº”åˆ°èµ„æºæ•°æ®ä¸­çš„`entryType`å­—æ®µã€‚

```js
const entries = window.performance.getEntriesByName(name, type);
```

### getEntriesByType

> è¯¥æ–¹æ³•è¿”å›å½“å‰å­˜åœ¨äºç»™å®š*ç±»å‹*çš„æ€§èƒ½æ—¶é—´çº¿ä¸­çš„å¯¹è±¡`PerformanceEntry`å¯¹è±¡æ•°ç»„ã€‚`type`å–å€¼å¯¹åº”åˆ°èµ„æºæ•°æ®ä¸­çš„`entryType`å­—æ®µã€‚

```js
const entries = window.performance.getEntriesByType(type);
```

## å°è¯•è·å–é™æ€èµ„æºæ•°æ®

ä½¿ç”¨`getEntriesByType`è·å–æŒ‡å®šç±»å‹çš„æ€§èƒ½æ•°æ®ï¼Œ**performance entryType**ä¸­æœ‰ä¸€ä¸ªå€¼ä¸º`resource`ï¼Œç”¨æ¥è·å–æ–‡æ¡£ä¸­èµ„æºçš„è®¡æ—¶ä¿¡æ¯ã€‚è¯¥ç±»å‹åŒ…æ‹¬æœ‰ï¼š`script`ã€`link`ã€`img`ã€`css`ã€`xmlhttprequest`ã€`beacon`ã€`fetch`ã€`other`ç­‰ã€‚

```js
const resource = performance.getEntriesByType('resource')
console.log('resource', resource)
```

è¿™æ ·å¯ä»¥è·å–åˆ°éå¸¸å¤šå…³äºèµ„æºåŠ è½½çš„æ•°æ®ï¼š

<img src="/Users/songyao/Library/Application Support/typora-user-images/image-20240422180428245.png" alt="image-20240422180428245" style="zoom:35%;" />

ä¸ºäº†æ–¹ä¾¿æŸ¥çœ‹ï¼Œæˆ‘ä»¬æ¥ç¨å¾®å¤„ç†ä¸‹æ•°æ®

```js
const resourceList = []
const resource = performance.getEntriesByType('resource')
console.log('resource', resource)
resource.forEach((item) => {
  resourceList.push({
    type: item.initiatorType, // èµ„æºç±»å‹
    name: item.name, // èµ„æºåç§°
    loadTime: `${(item.duration / 1000).toFixed(3)}s`, // èµ„æºåŠ è½½æ—¶é—´
    size: `${(item.transferSize / 1024).toFixed(0)}kb`, // èµ„æºå¤§å°
  })
})
```

<img src="/Users/songyao/Library/Application Support/typora-user-images/image-20240422180933393.png" alt="image-20240422180933393" style="zoom:50%;" />

è¿™æ ·å¯¹äºæ¯ä¸ªèµ„æºçš„ç±»å‹ã€åç§°ã€åŠ è½½æ—¶é•¿ä»¥åŠå¤§å°ï¼Œéƒ½éå¸¸æ¸…æ™°

ä½†æ˜¯æœ‰äº›èµ„æºçš„å¤§å°ä¸ºä»€ä¹ˆä¼šæ˜¯0å‘¢ï¼Ÿä»¥åŠè¿˜æœ‰å¾ˆå¤šé¡µé¢ä¸Šçš„èµ„æºè²Œä¼¼æ²¡æœ‰ç»Ÿè®¡åˆ°ï¼Œè¿™æ˜¯ä¸ºå•¥å‘¢ï¼ŸğŸ¤”

**è¿™æ˜¯å› ä¸ºé¡µé¢ä¸Šçš„èµ„æºè¯·æ±‚å¹¶ä¸æ˜¯ä¸€æ¬¡æ€§åŠ è½½å®Œçš„ï¼Œæ¯”å¦‚ä¸€äº›èµ„æºçš„æ‡’åŠ è½½ï¼Œè¿™é‡Œå°±æœ‰å¯èƒ½ä¼šç»Ÿè®¡ä¸åˆ°ï¼Œæˆ–è€…èµ„æºå¤§å°ç»Ÿè®¡ä¼šæœ‰é—®é¢˜ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç›‘å¬èµ„æºçš„åŠ¨æ€åŠ è½½**

## ç›‘å¬èµ„æºåŠ è½½

ä»¥ä¸Šä»‹ç»çš„3ä¸ªAPIéƒ½æ— æ³•åšåˆ°å¯¹èµ„æºåŠ¨æ€åŠ è½½çš„ç›‘å¬ï¼Œè¿™é‡Œå°±éœ€è¦ç”¨åˆ°`PerformanceObserver`æ¥å¤„ç†åŠ¨æ€åŠ è½½çš„èµ„æºäº†

### PerformanceObserver

> `PerformanceObserver` ä¸»è¦ç”¨äºç›‘æµ‹æ€§èƒ½åº¦é‡äº‹ä»¶ï¼Œåœ¨æµè§ˆå™¨çš„æ€§èƒ½æ—¶é—´è½´è®°å½•æ–°çš„ `performanceEntry` æ—¶ä¼šè¢«é€šçŸ¥ã€‚
>
> é€šè¿‡ä½¿ç”¨ PerformanceObserver() æ„é€ å‡½æ•°æˆ‘ä»¬å¯ä»¥åˆ›å»ºå¹¶è¿”å›ä¸€ä¸ªæ–°çš„ `PerformanceObserver` å¯¹è±¡ï¼Œä»è€Œè¿›è¡Œæ€§èƒ½çš„ç›‘æµ‹ã€‚

### ç”¨æ³•

`PerformanceObserver` ä¸å…¶å®ƒå‡ ä¸ª `Observer` ç±»ä¼¼ï¼Œä½¿ç”¨å‰éœ€è¦å…ˆè¿›è¡Œå®ä¾‹åŒ–ï¼Œç„¶åä½¿ç”¨ `observe` ç›‘å¬ç›¸åº”çš„äº‹ä»¶

```js
function perf_observer(list, observer) {
  // ...
}
var observer = new PerformanceObserver(perf_observer);
observer.observe({ entryTypes: ["resource"] });

```

å®ƒä¸»è¦æœ‰ä»¥ä¸‹å®ä¾‹æ–¹æ³•ï¼š

- observeï¼šæŒ‡å®šç›‘æµ‹çš„ `entry types`çš„é›†åˆã€‚å½“ `performance entry` è¢«è®°å½•å¹¶ä¸”æ˜¯æŒ‡å®šçš„ `entryTypes` ä¹‹ä¸€çš„æ—¶å€™ï¼Œæ€§èƒ½è§‚å¯Ÿè€…å¯¹è±¡çš„å›è°ƒå‡½æ•°ä¼šè¢«è°ƒç”¨ã€‚
- disconnectï¼šæ€§èƒ½ç›‘æµ‹å›è°ƒåœæ­¢æ¥æ”¶PerformanceEntryã€‚
- takeRecordsï¼šè¿”å›å½“å‰å­˜å‚¨åœ¨æ€§èƒ½è§‚å¯Ÿå™¨çš„ `performance entry`åˆ—è¡¨ï¼Œå¹¶å°†å…¶æ¸…ç©ºã€‚

### å°è¯•è·å–é¡µé¢å›¾ç‰‡åŠ è½½ä¿¡æ¯

```js
new PerformanceObserver((list) => {
  list
    .getEntries()
    .filter(
    (entry) =>
    entry.initiatorType === 'img' || entry.initiatorType === 'css',
  )
    .forEach((entry) => {
    resourceList.push({
      name: entry.name, // èµ„æºåç§°
      loadTime: `${(entry.duration / 1000).toFixed(3)}s`, // èµ„æºåŠ è½½æ—¶é—´
      type: entry.initiatorType, // èµ„æºç±»å‹
      size: `${(entry.transferSize / 1024).toFixed(0)}kb`, // èµ„æºå¤§å°
    })
    console.log('--', resourceList)
  })
}).observe({ entryTypes: ['resource'] })
```

**è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè·å–ç±»å‹é™¤äº†`img`è¿˜å¾—åŠ ä¸Š`css`ï¼Œå› ä¸ºCSSä¸­å¯èƒ½ä¼šæœ‰é€šè¿‡`url()`åŠ è½½çš„èƒŒæ™¯å›¾ã€‚**

![image-20240422190753123](/Users/songyao/Desktop/songyao/fe-nanjiu/article/2024/2024-04/images/rs3.png)

è¿™æ ·ï¼Œé¡µé¢ä¸Šçš„å›¾ç‰‡å¤§å°ä»¥åŠåŠ è½½æ—¶é•¿ä¸€ç›®äº†ç„¶äº†

### é€šçŸ¥

æˆ‘ä»¬è‡ªå·±æ˜¯çŸ¥é“é—®é¢˜äº†ï¼Œä½†æ˜¯è¿˜è¦å°†è¿™äº›ä¿¡æ¯æ¨é€ç»™äº§å“åŠè¿è¥ï¼Œè¿™ä¸ªå¯ä»¥é€šè¿‡ä¼ä¸šå¾®ä¿¡æä¾›çš„APIæ¥è¿›è¡Œæ“ä½œï¼Œä¸æ»¡è¶³æ¡ä»¶çš„èµ„æºå°†è¿›è¡Œæ¨é€é€šçŸ¥ï¼š

```js
setTimeout(() => {
  axios.get('http://127.0.0.1:3000/jjapi/user/pushMessage', {
    params: {
      msgtype: 'markdown',
      markdown: {
        content: `
          <font color="warning">H5é¡¹ç›®èµ„æºåŠ è½½å¼‚å¸¸ï¼Œè¯·æ³¨æ„æŸ¥çœ‹</font>
          ç±»å‹ï¼š<font color="comment">å›¾ç‰‡èµ„æºå¤§å°è¶…å‡ºé™åˆ¶</font>
          å¼‚å¸¸æ•°é‡ï¼š<font color="comment">${resourceList.length}ä¾‹</font> 
          å¼‚å¸¸åˆ—è¡¨ï¼š<font color="comment">${resourceList.map(
            (item) => item.name,
          )}</font>`,
      },
    },
  })
}, 8000)
```

é€šçŸ¥å¦‚ä¸‹ï¼š

<img src="/Users/songyao/Library/Application Support/typora-user-images/image-20240423200702914.png" alt="image-20240423200702914" style="zoom:33%;" />

è¿™é‡Œä¸ºäº†é¿å…è·¨åŸŸï¼Œä½¿ç”¨`nest`è‡ªå·±åŒ…äº†ä¸€å±‚ï¼Œè¿™æ ·å°±èƒ½å¤ŸåŠæ—¶å‘ç°çº¿ä¸Šé…ç½®èµ„æºæ˜¯å¦æœ‰é—®é¢˜ï¼Œå¹¶ä¸”è¿™ä¸ªè„šæœ¬ä¹Ÿä¸éœ€è¦æ‰€æœ‰ç”¨æˆ·éƒ½æ‰§è¡Œï¼Œå› ä¸ºå¤§å®¶çš„èµ„æºéƒ½æ˜¯ä¸€æ ·çš„ï¼Œåªéœ€è¦é…ç½®ç‰¹å®šç™½åå•ï¼ˆæ¯”å¦‚å¼€å‘ã€æµ‹è¯•ã€äº§å“ï¼‰ï¼Œåœ¨é¡µé¢ä¸Šçº¿åï¼Œåœ¨è¿›è¡Œçº¿ä¸Šå›å½’çš„åŒæ—¶æ‰§è¡Œè¯¥è„šæœ¬å»ç›‘æµ‹ä¸Šçº¿é…ç½®èµ„æºæ˜¯å¦éƒ½åˆç†...

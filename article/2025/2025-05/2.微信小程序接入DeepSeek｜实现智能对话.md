## å‰è¨€

éšç€AIè¶Šæ¥è¶Šç«çƒ­ï¼Œè¶Šæ¥è¶Šå¤šçš„äº§å“éƒ½æ¥å…¥äº†DeepSeekï¼Œä»Šå¤©æˆ‘ä»¬å°±æ¥å°è¯•åœ¨å¾®ä¿¡å°ç¨‹åºä¸­é›†æˆå›½äº§é¡¶å°–å¤§æ¨¡å‹DeepSeekï¼Œ**è§£é”æ™ºèƒ½å¯¹è¯ï½œå®æ—¶ç¿»è¯‘ï½œé•¿æ–‡æœ¬ç”Ÿæˆä¸‰å¤§æ ¸å¿ƒåœºæ™¯**ã€‚

## å‡†å¤‡å·¥ä½œ

- æ³¨å†Œä¸€ä¸ªå¾®ä¿¡å°ç¨‹åºè´¦å·ï¼Œå¹¶ä¸”åˆ›å»ºæœ¬åœ°å°ç¨‹åºå·¥ç¨‹é¡¹ç›®

- å°ç¨‹åºåŸºç¡€åº“éœ€è¦åœ¨ `3.7.1` åŠä»¥ä¸Šç‰ˆæœ¬ï¼Œå…·å¤‡ **wx.cloud.extend.AI** å¯¹è±¡

- å°ç¨‹åºéœ€è¦å¼€é€šã€Œäº‘å¼€å‘ã€ï¼Œå¯åœ¨å°ç¨‹åºå¼€å‘å·¥å…·ä¸­ç‚¹å‡»å·¥å…·æ é‡Œçš„ã€Œäº‘å¼€å‘ã€æŒ‰é’®è¿›è¡Œå¼€é€šï¼Œå¹¶åˆ›å»ºç¯å¢ƒï¼ˆPSï¼šå¯¹äºé¦–æ¬¡ä½¿ç”¨äº‘å¼€å‘çš„ç”¨æˆ·ï¼Œç¬¬ä¸€ä¸ªæœˆå¥—é¤å…è´¹ï¼‰

![image-20250509163413550](/Users/songyao/Desktop/songyao/fe-nanjiu/article/2025/2025-05/images/2-1.png)

## å¼€å‘ï¼Œè°ƒç”¨å¤§æ¨¡å‹

ä»¥ä¸Šå·¥ä½œå®Œæˆåï¼Œæˆ‘ä»¬ä¼šå¾—åˆ°ä¸€ä¸ªäº‘å¼€å‘ç¯å¢ƒIDï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥æ­£å¼æ¥å…¥ DeepSeek APIã€‚è¿™é‡Œæˆ‘ä½¿ç”¨çš„æ˜¯`Taro`æ¡†æ¶ï¼Œå¼€å‘è¿‡ç¨‹ä¸­ä¼šé‡åˆ°ä¸€äº›å‘ç‚¹ï¼Œä¸€èµ·å¾€ä¸‹çœ‹çœ‹éƒ½æ˜¯å¦‚ä½•è§£å†³çš„ã€‚

### åˆå§‹åŒ–äº‘å¼€å‘ç¯å¢ƒ

```js
if(process.env.TARO_ENV === 'weapp') {
  Taro.cloud.init({
    env: 'cloud1-6gxxxxxxxxxxxx'
  })
}
```

### åˆ›å»ºAIæ¨¡å‹

```js
const init = async () => {
   model = Taro.cloud.extend.AI.createModel("deepseek");
  // åˆ›å»ºæ¨¡å‹å®ä¾‹ï¼Œè¿™é‡Œä½¿ç”¨ DeepSeek å¤§æ¨¡å‹
}
```

### è°ƒç”¨ç”Ÿæˆæ–‡æœ¬

```js
const userInput = ref('')  // ç”¨æˆ·è¾“å…¥å†…å®¹
const messageList = ref<ChatMessage[]>([])  // å¯¹è¯åˆ—è¡¨

const send = async () => {
  const res = await model.streamText({
      data: {
        model: "deepseek-r1", // æŒ‡å®šå…·ä½“çš„æ¨¡å‹
        messages: [
          { role: "user", content: userInput.value },
        ],
      },
  })
  
  // push ç”¨æˆ·è¾“å…¥çš„æ¶ˆæ¯åˆ°æ¶ˆæ¯åˆ—è¡¨
  messageList.value.push({
    role: 'user',
    content: userInput.value,
  })
  userInput.value = ''  // æ¸…ç©ºè¾“å…¥æ¡†
  
  if(res.textStream) {
     // å…ˆpushä¸€æ¡ç©ºå†…å®¹,è¡¨ç¤ºaiè¿”å›å†…å®¹
    messageList.value.push({
      role: 'ai',
      content: '',
    })
     // æ¥æ”¶å¤§æ¨¡å‹çš„å“åº”
    // ç”±äºå¤§æ¨¡å‹çš„è¿”å›ç»“æœæ˜¯æµå¼çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œéœ€è¦å¾ªç¯æ¥æ”¶å®Œæ•´çš„å“åº”æ–‡æœ¬ã€‚
    for await (let str of res.textStream) {
      messageList.value[messageList.value.length - 1].content += str;
    }
  }
}
```

æ•´ä¸ªåŸºæœ¬å¯¹è¯æµç¨‹å°±å¥½äº†ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹æ•ˆæœï¼ŒUIéƒ¨åˆ†ä»£ç å°±ä¸è´´äº†ï¼Œæ¯”è¾ƒç®€å•ï¼ˆä¸€ä¸ªè¾“å…¥æ¡†ä¸€ä¸ªåˆ—è¡¨ï¼‰

![2-2](/Users/songyao/Desktop/songyao/fe-nanjiu/article/2025/2025-05/images/2-2.gif)

å¯ä»¥çœ‹åˆ°ï¼Œè¿™æ ·æˆ‘ä»¬å°±å®Œæˆäº†AIå¯¹è¯çš„åŸºæœ¬äº¤äº’ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªé—®é¢˜ï¼ŒAIæ€è€ƒè¿‡ç¨‹æ—¶é—´æ¯”è¾ƒé•¿ï¼Œç”¨æˆ·å¯¹è¿™ä¸ªè¿‡ç¨‹æ— æ„ŸçŸ¥ï¼Œå®¹æ˜“äº§ç”Ÿæ— å“åº”çš„é”™è§‰ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¼˜åŒ–ä¸€ä¸‹å¤§æ¨¡å‹æ€è€ƒç­‰å¾…è¿‡ç¨‹çš„æç¤ºäº¤äº’ã€‚

`model.streamText`é™¤äº†å¯ä»¥ä¼ å…¥dataæ•°æ®ï¼Œä¹Ÿå¯ä»¥ä¼ å…¥ä¸€äº›äº‹ä»¶ç›‘å¬ï¼Œéœ€è¦åæ§½ä¸€ä¸‹å¾®ä¿¡å¼€å‘æ–‡æ¡£ï¼Œå†™çš„å¤ªç²—ç³™äº†ï¼Œäº‹ä»¶é‡Œé¢çš„å‚æ•°åŠæ•°æ®ä¸€ä¸ªä¹Ÿæ²¡ä»‹ç»ï¼Œå®Œå…¨éœ€è¦è‡ªå·±è°ƒè¯•æ‘¸ç´¢...

![image-20250509182551743](/Users/songyao/Desktop/songyao/fe-nanjiu/article/2025/2025-05/images/2-3.png)

```js
const isGenerating = ref(false)
const send = async () => {
  console.log('å‘é€æ¶ˆæ¯', userInput.value)
  if(isGenerating.value) {
    Taro.showToast({
      title: 'æ­£åœ¨ç”Ÿæˆä¸­ï¼Œè¯·ç¨åå†è¯•',
      icon: 'none',
    })
    return
  }
  isGenerating.value = true

  // å°†ç³»ç»Ÿæç¤ºè¯å’Œç”¨æˆ·è¾“å…¥ï¼Œä¼ å…¥å¤§æ¨¡å‹
  const res = await model.streamText({
    data: {
      model: "deepseek-r1", // æŒ‡å®šå…·ä½“çš„æ¨¡å‹
      messages: [
        { role: "user", content: userInput.value },
      ],
    },
    onEvent: (event: any) => {
      console.log('event', event);
      // å¤„ç†äº‹ä»¶æµ
      if(event.delta) {
        // å¼€å§‹è¿”å›å†…å®¹
        console.log('å¼€å§‹è¿”å›å†…å®¹', event.delta);
        messageList.value[messageList.value.length - 1].status = 2;
      }else if(event.data === '[DONE]') {
        // ç»“æŸè¿”å›å†…å®¹
        console.log('ç»“æŸè¿”å›å†…å®¹');
        messageList.value[messageList.value.length - 1].status = 3;
      }
    },
    onFinish: (event: any) => {
      console.log('finish', event);
      // å¤„ç†å®Œæˆäº‹ä»¶
      messageList.value[messageList.value.length - 1].status = 3;
    },
  });
  // push ç”¨æˆ·è¾“å…¥çš„æ¶ˆæ¯åˆ°æ¶ˆæ¯åˆ—è¡¨
  messageList.value.push({
    role: 'user',
    content: userInput.value,
    status: 3
  })
  userInput.value = ''

  if(res.textStream) {
    messageList.value.push({
      role: 'ai',
      content: '',
      status: 0,
    })
    // ç”±äºå¤§æ¨¡å‹çš„è¿”å›ç»“æœæ˜¯æµå¼çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œéœ€è¦å¾ªç¯æ¥æ”¶å®Œæ•´çš„å“åº”æ–‡æœ¬ã€‚
    for await (let str of res.textStream) {
      messageList.value[messageList.value.length - 1].content += str;
    }
  }
  isGenerating.value = false
}
```

é€šè¿‡äº‹ä»¶ç›‘å¬ä¸ºæ¯æ¡æ¶ˆæ¯åŠ ä¸Šäº†ä¸€ä¸ª`status`çŠ¶æ€

```js
status: number // 0: å‘é€ä¸­ 1: æ€è€ƒä¸­ 2: å›ç­”ä¸­ 3: å›ç­”å®Œæˆ
```

```html
<view v-else>
  <view v-if="item.status < 2">æ€è€ƒä¸­ğŸ’­...</view>
  <view class="ai_message" v-else v-html="item.content"></view>
</view>
```

å†æ¥çœ‹çœ‹æ­¤æ—¶çš„æ•ˆæœï¼š

![2-4](/Users/songyao/Desktop/songyao/fe-nanjiu/article/2025/2025-05/images/2-4.gif)

## å¤„ç†markdown

ç”±äºå¤§æ¨¡å‹è¿”å›çš„å†…å®¹å¯èƒ½ä¼šå«æœ‰markdownè¯­æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸å€¼ç®€å•çš„ç›´æ¥å°†å¤§æ¨¡å‹è¿”å›çš„å†…å®¹ç›´æ¥è¿›è¡Œæ¸²æŸ“ï¼Œè¿™æ ·å°±æ— æ³•è¿˜åŸå¤§æ¨¡å‹åå‡ºçš„æ’ç‰ˆ

æ¯”å¦‚ï¼š

![image-20250509184141196](/Users/songyao/Desktop/songyao/fe-nanjiu/article/2025/2025-05/images/2-5.png)

è¿™äº›markdownè¯­æ³•éƒ½æ²¡æœ‰æŒ‰é¢„æœŸæ’ç‰ˆè¿›è¡Œæ¸²æŸ“ï¼Œä¸ºäº†æ’ç‰ˆæ›´åŠ å¥½çœ‹ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å¤„ç†markdownè¯­æ³•ã€‚

å°ç¨‹åºè™½ç„¶æ”¯æŒæ¸²æŸ“å¯Œæ–‡æœ¬ï¼Œä½†æ˜¯å¦‚ä½•æ¸²æŸ“ Markdown æ˜¯ä¸€ä¸ªé—®é¢˜ã€‚ç»è¿‡è°ƒç ”ï¼Œæˆ‘æ‰¾åˆ°äº† [towxml](https://github.com/sbfkcel/towxml)ç¬¬ä¸‰æ–¹ç»„ä»¶ï¼Œå®ƒé™¤äº†æ”¯æŒåŸºæœ¬çš„ Markdown è¯­æ³•ï¼Œè¿˜æ”¯æŒä¸‹é¢ä¸‰ç§æ ¼å¼çš„æ¸²æŸ“ï¼š

1. æ”¯æŒ echarts å›¾è¡¨ï¼ˆ3.0+ï¼‰
2. æ”¯æŒ LaTex æ•°å­¦å…¬å¼ï¼ˆ3.0+ï¼‰
3. æ”¯æŒ yuml æµç¨‹å›¾ï¼ˆ3.0+ï¼‰

**âš ï¸éœ€è¦æ³¨æ„çš„æ˜¯ï¼šTowxml æ˜¯çº¯å¾®ä¿¡å°ç¨‹åºç»„ä»¶ï¼Œæ‰€ä»¥æƒ³è¦åœ¨taroé¡¹ç›®ä¸­ä½¿ç”¨ï¼Œè¿˜æ˜¯æœ‰ç‚¹éº»çƒ¦çš„ã€‚**

### æ„å»º Towxml

1. ä¸‹è½½Towxmlæºç 

```shell
git clone https://github.com/sbfkcel/towxml.git
```

2. å®‰è£…ä¾èµ–ï¼Œè¿›å…¥é¡¹ç›®æ ¹ç›®å½•æ‰¾åˆ°`config.js`,æ ¹æ®é…ç½®æ–‡ä»¶æ„å»ºè‡ªå·±éœ€è¦çš„åŠŸèƒ½

```shell
npm install
```

ç”±äºæˆ‘åªéœ€è¦markdownéƒ¨åˆ†çš„å¤„ç†ï¼Œæ‰€ä»¥å¯¹äºechartsã€laTexã€yumlæˆ‘éƒ½æ³¨é‡Šæ‰äº†ï¼Œå¯ä»¥å‡å°äº§ç‰©ä½“ç§¯

![image-20250509185424450](/Users/songyao/Desktop/songyao/fe-nanjiu/article/2025/2025-05/images/2-6.png)

3. æ‰“åŒ…ï¼Œå¹¶ä¸”å°†äº§ç‰©æ”¾å…¥taroé¡¹ç›®ä¸­ï¼Œä¿®æ”¹`decode.json`ç»„ä»¶å¼•å…¥è·¯å¾„

```shell
npm run build
```

![image-20250509185640956](/Users/songyao/Desktop/songyao/fe-nanjiu/article/2025/2025-05/images/2-7.png)

### ä½¿ç”¨Towxmlç»„ä»¶

äº§ç‰©æŒªåˆ°é¡¹ç›®åï¼Œå°±å¯ä»¥ä½¿ç”¨äº†ï¼Œç”±äºæ˜¯å°ç¨‹åºåŸç”Ÿç»„ä»¶ï¼Œæ‰€ä»¥éœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­è¿›è¡Œå¼•å…¥

```js
export default definePageConfig({
  usingComponents: {
    towxml: "./components/towxml/towxml"
  }
})
```

è°ƒç”¨**towxmlParse**æ–¹æ³•å¤„ç†`markdown`

```js
import towxmlParse from './components/towxml/index'

const send = async () => {
   // ...
    let content = ''
    for await (let str of res.textStream) {
      // messageList.value[messageList.value.length - 1].content += str;
      content += str;
      messageList.value[messageList.value.length - 1].content = towxmlParse(content, 'markdown');
    }
  // ...

}
```

æ‰“å¼€å¾®ä¿¡å¼€å‘è€…å·¥å…·ï¼Œä½ ä¼šå‘ç°æ§åˆ¶å°æœ‰è­¦å‘Šï¼Œç»„ä»¶ä¹Ÿä¸èƒ½æ­£å¸¸æ¸²æŸ“

![image-20250509190942156](/Users/songyao/Desktop/songyao/fe-nanjiu/article/2025/2025-05/images/2-8.png)

åŸå› æ˜¯ Vue æŠŠå®ƒå½“åš Vue ç»„ä»¶æ¥è§£æï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹ VueLoader çš„ç¼–è¯‘é…ç½® `compilerOptions.isCustomElement`ï¼ŒæŠŠæ­¤ç»„ä»¶å£°æ˜ä¸ºåŸç”Ÿç»„ä»¶ã€‚

```js
plugins: [
    [
      '@tarojs/plugin-framework-vue3',
      {
        vueLoaderOption: {
          compilerOptions: {
            isCustomElement: (tag) => tag.includes('towxml'),
            whitespace: 'preserve',
            // ...
          },
          reactivityTransform: true, // å¼€å¯vue3å“åº”æ€§è¯­æ³•ç³–
        },
      },
    ],
  ],
```

å†é‡å¯é¡¹ç›®æ¥çœ‹çœ‹æ•ˆæœï¼š

![2-9](/Users/songyao/Desktop/songyao/fe-nanjiu/article/2025/2025-05/images/2-9.gif)

å¯ä»¥çœ‹åˆ°æ­¤æ—¶çš„markdownæ¸²æŸ“å°±æ­£å¸¸äº†ã€‚

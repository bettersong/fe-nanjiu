## å‰è¨€

åœ¨è¿™ä¹‹å‰æˆ‘å†™è¿‡è¿™æ ·ä¸€ç¯‡æ–‡ç« [æ•™ä½ ç”¨canvasæ‰“é€ ä¸€ä¸ªç‚«é…·çš„ç¢ç‰‡åˆ‡å›¾æ•ˆæœ](https://juejin.cn/post/7157897308112650248)ï¼Œè¿™ä¸ªæ•ˆæœæ˜¯ç”¨Canvasæ¥å®ç°çš„ï¼Œç°åœ¨æƒ³ç€å°è¯•ä½¿ç”¨`CSS Paint API`æ¥å®ç°ä¸€ä¸ªç±»ä¼¼çš„ç¢ç‰‡æ•ˆæœã€‚

**å¦‚æœè¿™ç¯‡æ–‡ç« æœ‰å¸®åŠ©åˆ°ä½ ï¼Œâ¤ï¸å…³æ³¨+ç‚¹èµâ¤ï¸é¼“åŠ±ä¸€ä¸‹ä½œè€…ï¼Œæ–‡ç« å…¬ä¼—å·é¦–å‘ï¼Œå…³æ³¨ `å‰ç«¯å—ç–` ç¬¬ä¸€æ—¶é—´è·å–æœ€æ–°æ–‡ç« ï½**

## ç®€å•ä»‹ç»ä¸‹CSS Paint API

> CSS Paint APIæ˜¯Houdinié¡¹ç›®çš„ä¸€éƒ¨åˆ†ã€‚å®ƒå…è®¸æˆ‘ä»¬ä½¿ç”¨è‡ªå·±çš„åŠŸèƒ½æ‰©å±•CSSï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä¸å†éœ€è¦ç­‰å¾…æ–°åŠŸèƒ½çš„å‘å¸ƒï¼Œå®Œå…¨å¯ä»¥è‡ªå·±å®ç°æƒ³è¦çš„æ–°åŠŸèƒ½ï¼Œå¯ä»¥è¯´CSS Paint APIå°±æ˜¯CSSçš„æœªæ¥ã€‚Houdiniæ˜¯ä¸€ç»„åº•å±‚APIï¼Œå®ƒæš´éœ²ä¸€éƒ¨åˆ†CSSå¼•æ“ç»™å¼€å‘è€…ä»‹å…¥æµè§ˆå™¨æ¸²æŸ“ä¸å¸ƒå±€çš„èƒ½åŠ›ï¼Œä»è€Œèƒ½å¤Ÿæ‰©å±•CSSã€‚

W3Cä¸Šå…³äºCSS Paint APIçš„ä»‹ç»æ˜¯è¿™æ ·çš„ï¼š

> CSS `Paint API` å…è®¸å¼€å‘è€…ä½¿ç”¨ JavaScript åˆ›å»ºå¯¹æ ·å¼ä¸å¤§å°å˜åŒ–è‡ªé€‚åº”çš„ CSS å›¾åƒã€‚è¿™ç§æ–¹å¼åˆ›å»ºçš„å›¾åƒï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨ `paint()` å‡½æ•°ï¼Œåº”ç”¨åœ¨è¯¸å¦‚ `background-image`ã€`border-image` å’Œ `mask-image` ç­‰å±æ€§ä¸Šã€‚

æœ‰äº†è¿™ä¸ªAPIï¼Œæˆ‘ä»¬åœ¨CSSä¸­å¯ä»¥ç»˜åˆ¶ä»»æ„è‡ªå·±æƒ³è¦çš„å›¾æ¡ˆäº†ï¼Œæ˜¯ä¸æ˜¯æ³°è£¤è¾£ï¼

### ä½¿ç”¨

ä½¿ç”¨æµç¨‹å…·ä½“å¯ä»¥æŒ‰ç…§è¿™å¼ å›¾æ¥å³å¯ï¼š

<img src="/Users/songyao/Desktop/songyao/fe-nanjiu/images/0319/paint1.png" alt="paint1" style="zoom:50%;" />

1. åˆ›å»ºä¸€ä¸ª js æ–‡ä»¶ï¼Œä½¿ç”¨ `registerPaint()` æ–¹æ³•æ³¨å†Œä¸€ä¸ª PaintWorklet
2. è°ƒç”¨ `addModule()` æ–¹æ³•æ·»åŠ æ­¤æ¨¡å—
3. åœ¨ CSS ä¸­ä½¿ç”¨ `paint()` å‡½æ•°è°ƒç”¨

æ›´å…·ä½“çš„ä»‹ç»å¯ä»¥åœ¨MDNä¸ŠæŸ¥çœ‹ï¼Œäº†è§£å®Œå¤§æ¦‚çš„ä½¿ç”¨æµç¨‹æˆ‘ä»¬å°±å¯ä»¥å¼€å§‹å°è¯•å®ç°æˆ‘ä»¬çš„å›¾åƒç¢ç‰‡æ•ˆæœäº†

## å¼€å§‹åˆ¶ä½œ

### åˆæ­¥ç»˜åˆ¶

é¦–å…ˆæˆ‘ä»¬ä½¿ç”¨Paint APIå°†æˆ‘ä»¬çš„å›¾ç‰‡ç»˜åˆ¶æˆä¸ºä¸€åŠä¸é€æ˜ä¸€åŠé€æ˜çš„æ•ˆæœï¼š

```vue
<template>
  <div :class="$style.paint_container">
    <img src="/public/3.jpg" :class="$style.paint_img1" />
  </div>
</template>

<script lang="ts" setup>
import { onMounted } from "vue";
// import paintSuipian from "../../utils/paintSuipian";

const paint = () => {
  if (CSS.paintWorklet) {
    CSS.paintWorklet.addModule("/src/utils/paintSuipian1.js");
  }
};

onMounted(() => {
  paint();
});
</script>
<style lang="scss" module>
.paint_img1 {
  width: 400px;
  height: auto;
  --m: 12;
  --n: 12;
  -webkit-mask: paint(suipian1);
}
</style>
```

```js
// paintSuipian1.js
registerPaint(
  "suipian1",
  class {
    paint(ctx, size) {
      console.log("ctx:", ctx, "size:", size);
      /* left */
      ctx.fillStyle = "rgba(0,0,0,1)";
      ctx.fillRect(0, 0, size.width / 2, size.height);
      /* right */
      ctx.fillStyle = "rgba(0,0,0,0.5)";
      ctx.fillRect(size.width / 2, 0, size.width / 2, size.height);
    }
  }
);

```

ä»è¿™é‡Œæ¥çœ‹ï¼Œpaintå†…éƒ¨çš„ä¸€äº›æ“ä½œAPIå…¶å®ä¸æˆ‘ä»¬ç†Ÿæ‚‰çš„Canvasæœ‰ç‚¹ç±»ä¼¼ï¼Œctxå°±æ˜¯å½“å‰çš„ç»˜åˆ¶ä¸Šä¸‹æ–‡ï¼Œè€Œsizeåˆ™æ˜¯åº”ç”¨è¿™ä¸ªpaintå…ƒç´ çš„å®½é«˜å¤§å°ã€‚

æ‰€ä»¥ä»è¿™é‡Œçœ‹ä¸Šå»ç†è§£å¹¶ä¸éš¾ï¼Œä¸Canvaså·®ä¸å¤šï¼Œé€šè¿‡`fillRect`ç»˜åˆ¶çŸ©å½¢ï¼Œç„¶åé€šè¿‡`fillStyle`å¡«å……æŸ“è‰²ï¼Œæˆ‘ä»¬å°±èƒ½çœ‹åˆ°ä¸‹é¢è¿™ä¸ªæ•ˆæœï¼š

![image-20230521155905180](/Users/songyao/Desktop/songyao/fe-nanjiu/images/0319/paint2.png)

çœ‹åˆ°è¿™ä¸ªæ•ˆæœæˆ‘ä»¬æ˜¯ä¸æ˜¯å°±èƒ½å¤Ÿæƒ³è±¡åˆ°ä¹‹å‰çš„é‚£ç§ç¢ç‰‡æ•ˆæœåº”è¯¥æ€æ ·å»å®ç°å‘¢ï¼Ÿ

è¿™ä¸Šé¢å…¶å®å°±æ˜¯ç»˜åˆ¶äº†ä¸¤ä¸ªçŸ©å½¢ï¼Œåˆ†åˆ«å¡«å……äº†ä¸åŒçš„é€æ˜åº¦ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¦‚æœç»˜åˆ¶å¤šä¸€ç‚¹çš„çŸ©å½¢ä¹Ÿè®©å®ƒå¡«å……ä¸åŒçš„é€æ˜åº¦ä¼šæ˜¯ä»€ä¹ˆæ ·å­å‘¢ï¼Œå¤§å®¶å¯ä»¥æƒ³è±¡ä¸€ä¸‹ğŸ¤”...

### ç¨å¾®åŠ å·¥

ä¸ºäº†æ›´åŠ å®ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å®šä¹‰CSSå˜é‡æ¥è¾¾åˆ°æ§åˆ¶ç¢ç‰‡å¯†åº¦çš„æ•ˆæœã€‚

```js
// paintSuipian1.js
registerPaint(
  "suipian1",
  class {
    static get inputProperties() {
      return ["--m", "--n"];
    }
    paint(ctx, size, properties) {
      console.log("ctx:", ctx, "size:", size);
      const m = properties.get("--m");
      const n = properties.get("--n");

      const w = size.width / m;
      const h = size.height / n;

      for (var i = 0; i < n; i++) {
        for (var j = 0; j < m; j++) {
          ctx.fillStyle = "rgba(0,0,0," + Math.random() + ")";
          ctx.fillRect(i * w, j * h, w, h);
        }
      }
    }
  }
);

```

æ­¤æ—¶æˆ‘ä»¬çš„jsæ”¹çš„ç¨å¾®å¤æ‚äº†ä¸€ç‚¹ï¼Œå…¶å®ä¹Ÿè¿˜å¥½ï¼Œåªæ˜¯å®šä¹‰äº†ä¸€ä¸‹çŸ©å½¢çŸ©é˜µçš„ç»´åº¦ï¼Œç„¶åè®¡ç®—äº†æ²¡ä¸ªç¢ç‰‡çš„å®½é«˜ï¼Œå†ç»è¿‡forå¾ªç¯è¿›è¡Œç»˜åˆ¶ã€‚

**è¿™é‡Œæˆ‘ä»¬å¯ä»¥é€šè¿‡`get inputProperties`æ¥è·å–æˆ‘ä»¬CSSä¸­å®šä¹‰çš„å˜é‡ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œçš„è·å–çš„å˜é‡ä¹Ÿæ˜¯æœ‰ä½œç”¨åŸŸçš„ï¼Œå®ƒåªèƒ½è·å–åˆ°è‡ªå·±èº«å®šä¹‰çš„å˜é‡æˆ–è€…æ˜¯å®ƒç»§æ‰¿è€Œæ¥çš„CSSå˜é‡**

```css
.paint_img1 {
  width: 400px;
  height: auto;
  --m: 12;
  --n: 12;
  -webkit-mask: paint(suipian1);
}
```

ç°åœ¨è¿™å¼ å›¾ç‰‡ä¼šå˜æˆä»€ä¹ˆæ ·å‘¢ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ï¼š

![image-20230521161411023](/Users/songyao/Desktop/songyao/fe-nanjiu/images/0319/paint3.png)

è¿™æ ·ä¸€çœ‹æ˜¯ä¸æ˜¯æœ‰ç‚¹æ„Ÿè§‰äº†

æˆ‘ä»¬å¯ä»¥é€šè¿‡æ§åˆ¶CSSå˜é‡æ¥å®ç°ä¸åŒçš„æ•ˆæœï¼Œæ¯”å¦‚ï¼š

```css
.paint_img1 {
  width: 400px;
  height: auto;
  --m: 22;
  --n: 22;
  -webkit-mask: paint(suipian1);
}
```



![image-20230521161638897](/Users/songyao/Desktop/songyao/fe-nanjiu/images/0319/paint4.png)

### æ·»åŠ åŠ¨ç”»

åˆ°è¿™äº†ï¼Œæ•´ä¸ªç¢ç‰‡çš„è½®å»“å¤§æ¦‚æ˜¯æœ‰äº†ï¼Œç°åœ¨éœ€è¦åšçš„æ˜¯æ€ä¹ˆä¸ºè¿™äº›ç¢ç‰‡åŠ ä¸ŠåŠ¨ç”»ï¼Ÿ

è¿™é‡Œæœ‰ä¸ªæŠ€å·§æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨`@property`æ¥è‡ªå®šä¹‰ä¸€ä¸ªå±æ€§ï¼Œè¿™ä¸ªå±æ€§å…¶å®æ˜¯ä¸€ä¸ª`Number`å€¼ï¼Œè€Œè¿™ä¸ªå€¼åˆæ°å¥½æ˜¯æˆ‘ä»¬æ¯ä¸ªç¢ç‰‡è®¡ç®—éšæœºé€æ˜åº¦éœ€è¦ç”¨çš„å€¼ï¼Œç„¶åæˆ‘ä»¬å†ä½¿ç”¨transitionå†å¯¹è¿™ä¸ªè‡ªå®šä¹‰å±æ€§è¿›è¡Œè¿‡æ¸¡ã€‚

OKï¼Œæˆ‘ä»¬æ¥å°è¯•ä¸€ä¸‹:

```js
// paintSuipian1.js
registerPaint(
  "suipian1",
  class {
    static get inputProperties() {
      return ["--m", "--n", "--f"];
    }
    paint(ctx, size, properties) {
      console.log("ctx:", ctx, "size:", size);
      const m = properties.get("--m");
      const n = properties.get("--n");
      const f = properties.get("--f");

      const w = size.width / m;
      const h = size.height / n;

      for (var i = 0; i < n; i++) {
        for (var j = 0; j < m; j++) {
          ctx.fillStyle = "rgba(0,0,0," + f + ")";
          ctx.fillRect(i * w - 0.5, j * h - 0.5, w + 0.5, h + 0.5);
        }
      }
    }
  }
);

```

```css
.paint_img1 {
  width: 400px;
  height: auto;
  --m: 10;
  --n: 10;
  --f: 1;
  -webkit-mask: paint(suipian1);
  transition: --f 1s;
}
.paint_img1:hover {
  --f: 0;
}
```

çœ‹çœ‹æ•ˆæœï¼š

![paint5](/Users/songyao/Desktop/songyao/fe-nanjiu/images/0319/paint5.gif)

è¿™é‡Œçœ‹ç€æœ‰ç‚¹æ€ªæ€ªçš„ï¼Œå› ä¸ºæ‰€æœ‰çš„ç¢ç‰‡éƒ½ä¼šåŒæ—¶éšè—å‡ºç°ï¼Œå¹¶æ²¡æœ‰è¾¾åˆ°æˆ‘ä»¬æƒ³è¦çš„æ•ˆæœï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬è¿˜å¾—æƒ³åŠæ³•é˜²æ­¢æ‰€æœ‰çš„ç¢ç‰‡åŒæ—¶æ˜¾ç¤ºéšè—ğŸ¤”

### æœ€åä¼˜åŒ–

è¿™é‡Œå…¶å®éœ€è¦é€šè¿‡ä¸€ç§ç®—æ³•æ¥è®©æ¯ä¸ªç¢ç‰‡çš„ä¸é€æ˜åº¦è¾¾åˆ°ä¸€ä¸ªéšæœºçš„æ•ˆæœã€‚

```js
// paintSuipian.js
registerPaint(
  "suipian",
  class {
    static get inputProperties() {
      return ["--color", "--m", "--n", "--f"];
    }
    paint(ctx, size, properties) {
      console.log("ctx:", ctx, "size:", size, properties.get("--color"));
      const m = properties.get("--m");
      const n = properties.get("--n");
      const f = properties.get("--f");
      const w = size.width / m;
      const h = size.height / n;
      const l = 10;

      const mask = 0xffffffff;
      const seed = 30;
      let m_w = (123456789 + seed) & mask;
      let m_z = (987654321 - seed) & mask;
			// éšæœºç®—æ³•
      const random = function () {
        m_z = (36969 * (m_z & 65535) + (m_z >>> 16)) & mask;
        m_w = (18000 * (m_w & 65535) + (m_w >>> 16)) & mask;
        let result = ((m_z << 16) + (m_w & 65535)) >>> 0;
        result /= 4294967296;
        return result;
      };

      for (let i = 0; i < n; i++) {
        for (let j = 0; j < m; j++) {
          ctx.fillStyle =
            "rgba(0,0,0," + (random() * (l - 1) + 1 - (1 - f) * l) + ")";
          ctx.fillRect(i * w - 1, j * h - 1, w + 1, h + 1);
        }
      }
    }
  }
);

```

```css
.paint_img {
  width: 400px;
  height: auto;
  --color: rgba(255, 255, 255, 1);
  --m: 10;
  --n: 10;
  --f: 1;
  -webkit-mask: paint(suipian);
  transition: --f 1s;
}
.paint_img:hover {
  --f: 0;
}
```

æœ€åçš„æ•ˆæœï¼š

![paint6](/Users/songyao/Desktop/songyao/fe-nanjiu/images/0319/paint6.gif)

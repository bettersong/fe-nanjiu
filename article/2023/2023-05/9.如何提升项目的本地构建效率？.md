## å‰è¨€

æœ€è¿‘å†™H5çš„é¡¹ç›®æ¯”è¾ƒå¤šï¼Œè¯¥é¡¹ç›®ä»å¹´é¾„ä¸Šçœ‹ç€è¿˜ç®—æ¯”è¾ƒå¹´è½»ğŸ˜‚ï¼Œæ•´ä¸ªæ¶æ„åº”è¯¥æ˜¯ç›´æ¥ä½¿ç”¨vue-cliåŸºäºvue2ç”Ÿæˆçš„ï¼Œé‚£åº•å±‚æ‰“åŒ…å·¥å…·è‡ªç„¶ä¹Ÿå°±æ˜¯webpackï¼Œæˆ‘ä»¬çŸ¥é“webpackæœ‰ä¸ªé€šç—…ï¼Œé‚£å°±æ˜¯éšç€é¡¹ç›®çš„ä¸æ–­å¢å¤§æ¯æ¬¡æ„å»ºçš„æ—¶é—´ä¹Ÿä¼šéšä¹‹è¶Šæ¥è¶Šé•¿ã€‚æ¯”å¦‚æˆ‘ä»¬è¿™ä¸ªé¡¹ç›®çš„å•æ¬¡å†·å¯åŠ¨å°±è¾¾åˆ°äº†æƒŠäººçš„1åˆ†20ç§’å·¦å³ï¼Œæ¯æ¬¡è·‘å®Œç”µè„‘é£æ‰‡è½¬çš„é£èµ·ï¼Œç®€ç›´å¿ä¸äº†ï¼ï¼ˆå¯èƒ½æ˜¯ç”µè„‘å¤ªè€äº†ï¼‰

ä¸‹é¢ä¸€èµ·çœ‹çœ‹å¦‚ä½•å°†é¡¹ç›®çš„å†·å¯åŠ¨æ—¶é•¿ä»1åˆ†20ç§’å·¦å³ä¼˜åŒ–åˆ°åå‡ ç§’å·¦å³å§ï½

## æ˜¯ä»€ä¹ˆè®©æ„å»ºæ•ˆç‡è¿™ä¹ˆæ…¢ï¼Ÿ

### é¡µé¢æ•°é‡

ç”±äºæˆ‘ä»¬è¿™ä¸ªé¡¹ç›®æ˜¯ä¸ªSPAé¡¹ç›®ï¼Œè·¯ç”±æ˜¯é€šè¿‡`vue-auto-routing`æ¥è‡ªåŠ¨ç”Ÿæˆçš„ã€‚ä¸ºäº†æ›´ç›´è§‚çš„çœ‹åˆ°é‡Œé¢æœ‰å¤šå°‘ä¸ªé¡µé¢ï¼Œäºæ˜¯æˆ‘æŠŠ`routes`æ‰“å°å‡ºæ¥äº†ã€‚

![image-20230526143742597](/Users/songyao/Desktop/songyao/fe-nanjiu/images/0319/build-1.png)

å±…ç„¶æœ‰258ä¸ªä¹‹å¤šï¼é¡µé¢è¿™ä¹ˆå¤šï¼Œwebpackæ‰“åŒ…æ„å»ºçš„é€Ÿåº¦è‡ªç„¶å°±ä¼šæ…¢ã€‚

**å¾ˆå¥½å¥‡çš„ä¸€ç‚¹è¿™ä¹ˆå¤šé¡µé¢éƒ½æ˜¯çº¿ä¸Šåœ¨è·‘çš„ï¼Ÿ**

### æ—¶é—´éƒ½ç”¨åœ¨å“ªï¼Ÿ

ä¸ºäº†å¯¹é¡¹ç›®åšä¸€äº›æœ‰é’ˆå¯¹æ€§çš„ä¼˜åŒ–ï¼Œæˆ‘ä»¬éœ€è¦äº†è§£æ•´ä¸ªç¼–è¯‘è¿‡ç¨‹ä¸­è€—æ—¶åˆ†å¸ƒï¼ŒçŸ¥é“äº†å„æ¨¡å—çš„è€—æ—¶æ•°æ®æˆ‘ä»¬æ‰èƒ½å¯¹ç—‡ä¸‹è¯ã€‚

è¿™é‡Œå¯ä»¥ä½¿ç”¨`speed-measure-webpack-plugin`æ’ä»¶æ¥è¿›è¡Œåˆ†æã€‚

> `speed-measure-webpack-plugin`ä¸ä»…å¯ä»¥åˆ†ææ€»çš„æ‰“åŒ…æ—¶é—´ï¼Œè¿˜èƒ½åˆ†æå„é˜¶æ®µloader çš„è€—æ—¶ã€‚

```js
// ä½¿ç”¨
const SpeedMeasurePlugin = require('speed-measure-webpack-plugin')
const plugins = [
  // ...
  new SpeedMeasurePlugin(),
]
```

<img src="/Users/songyao/Library/Application Support/typora-user-images/image-20230526145949407.png" alt="image-20230526145949407" style="zoom:33%;" />

ä»ä¸Šå›¾æ¥çœ‹ï¼Œç¼–è¯‘è¿‡ç¨‹ä¸­çš„å¤§éƒ¨åˆ†æ—¶é—´éƒ½æ˜¯ç”¨åœ¨vueæ–‡ä»¶çš„ç¼–è¯‘å¤„ç†loaderä¸Šã€‚**è¯´ç™½äº†è¿˜æ˜¯æ–‡ä»¶å¤ªå¤šäº†å¯¼è‡´ç¼–è¯‘è€—æ—¶æ¯”è¾ƒé•¿ã€‚**

## å¦‚ä½•ä¼˜åŒ–ï¼Ÿ

### é€šç”¨æ–¹æ¡ˆ

#### å¼€å¯ç¼“å­˜

webpack ä¸­å‡ ç§ç¼“å­˜æ–¹å¼ï¼š

- **`cache-loader`**
- **`hard-source-webpack-plugin`**
- **`babel-loader çš„ cacheDirectory æ ‡å¿—`**

æˆ‘ä»¬è¿™ä¸ªé¡¹ç›®ä½¿ç”¨çš„`vue-cli`ç‰ˆæœ¬æ˜¯`4.1.0`ï¼Œå®ƒå·²ç»å†…ç½®äº† **`cache-loader`** å’Œ **`babel-loader çš„ cacheDirectory æ ‡å¿—`**ä¸¤ç§ç¼“å­˜

æˆ‘ä»¬å¯ä»¥äºŒæ¬¡å¯åŠ¨çœ‹çœ‹

<img src="/Users/songyao/Library/Application Support/typora-user-images/image-20230526164212949.png" alt="image-20230526164212949" style="zoom:50%;" />

äºŒæ¬¡å¯åŠ¨èŠ±è´¹äº†å¤§æ¦‚43ç§’ï¼Œæå‡è¿˜æ˜¯è›®å¤§çš„ï¼Œä¸»è¦åŸå› æ˜¯ "å†·å¯åŠ¨" æ—¶å·²ç»å°† **`babel-loaderã€vue-loader`** è¿›è¡Œäº†ç¼“å­˜ï¼š

<img src="/Users/songyao/Library/Application Support/typora-user-images/image-20230526164433013.png" alt="image-20230526164433013" style="zoom:50%;" />

å¦å¤–ä¸€ç§ç¼“å­˜å¯è‡ªè¡Œæµ‹è¯•**`hard-source-webpack-plugin`**ï¼Œä¸»è¦ç¼“å­˜è¿™ç§æ–¹æ¡ˆåªåœ¨äºŒæ¬¡å¯åŠ¨æ‰èƒ½æœ‰æ˜æ˜¾çš„æ€§èƒ½æå‡ï¼Œä¸æˆ‘é¦–æ¬¡å†·å¯åŠ¨å°±è¦**å¿«**çš„é¢„æœŸä¸ç¬¦ã€‚è¿™ç§æ–¹æ¡ˆè¿™é‡Œå°±ä¸å†è¯•äº†

#### å¼€å¯å¤šçº¿ç¨‹

ç”±äºjså•çº¿ç¨‹çš„ç‰¹ç‚¹ï¼Œå½“æœ‰å¤šä¸ªä»»åŠ¡åŒæ—¶å­˜åœ¨ï¼Œå®ƒä»¬ä¹Ÿåªèƒ½æ’é˜Ÿä¸²è¡Œæ‰§è¡Œã€‚

æ‰€ä»¥æœ‰æ²¡æœ‰å¯ä»¥ä½¿ç”¨ç±»ä¼¼`web Worker`çš„æŠ€æœ¯å®ç°å¤šçº¿ç¨‹ç¼–è¯‘å¤„ç†ï¼Œå°†éƒ¨åˆ†ä»»åŠ¡åˆ†è§£åˆ°å¤šä¸ªå­è¿›ç¨‹ä¸­å»å¹¶è¡Œå¤„ç†ï¼Œå­è¿›ç¨‹å¤„ç†å®ŒæˆåæŠŠç»“æœå‘é€åˆ°ä¸»è¿›ç¨‹ä¸­ï¼Œä»è€Œå‡å°‘æ€»çš„æ„å»ºæ—¶é—´ã€‚

**å¯é€‰æ–¹æ¡ˆï¼š**

- **thread-loader**ï¼ˆå®˜æ–¹æ¨å‡ºï¼‰
- **parallel-webpack**
- **HappyPack**

ä»ä¸Šé¢å¯ä»¥å‘ç°ï¼Œç¼–è¯‘è¿‡ç¨‹ï¼Œå¤§éƒ¨åˆ†æ—¶é—´éƒ½æ˜¯åœ¨å¤„ç†vueæ–‡ä»¶ï¼Œæ‰€ä»¥å¯ä»¥é’ˆå¯¹`vue-loader`ä½¿ç”¨`thread-loader`

```js
{
  test: /\.vue$/,
    include: path.resolve('src'),
      use: [
        {
          loader: 'thread-loader',
          options: {
            workers: 2,
          },
        },
      ],
},
```

> **æ³¨æ„**ï¼šä»…åœ¨è€—æ—¶çš„æ“ä½œä¸­ä½¿ç”¨ **thread-loader**ï¼Œå¦åˆ™ä½¿ç”¨ **thread-loader** ä¼šåå¯èƒ½ä¼šå¯¼è‡´é¡¹ç›®æ„å»ºæ—¶é—´å˜å¾—æ›´é•¿ï¼Œå› ä¸ºæ¯ä¸ª **worker** éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ **node** è¿›ç¨‹ï¼Œåˆ›å»ºworkerçš„è¿‡ç¨‹ä¹Ÿæ˜¯è€—æ—¶çš„ï¼Œå°½é‡ä¸è¦å¾—ä¸å¿å¤±ã€‚

æ­¤æ—¶çš„ç¼–è¯‘æ—¶é—´ä¸º41ç§’å·¦å³ï¼Œæå‡å¥½åƒå¹¶ä¸æ˜¯ç‰¹åˆ«æ˜æ˜¾ï¼Œå¯èƒ½åœ¨å¤§å‹é¡¹ç›®ä¸­æ‰ä¼šå‘æŒ¥å‡ºæ›´å¤§çš„ä½œç”¨ã€‚

<img src="/Users/songyao/Library/Application Support/typora-user-images/image-20230526191612353.png" alt="image-20230526191612353" style="zoom:50%;" />

å½“ç„¶è¿˜æœ‰å¾ˆå¤šæ–¹æ¡ˆå¯ä»¥ä¸€ä¸€å°è¯•ï¼Œä½†æˆ‘è§‰å¾—è¾¾åˆ°çš„æ•ˆæœåº”è¯¥éƒ½ä¸ä¼šè¶…è¿‡ä¸‹é¢è¿™ä¸ªé’ˆå¯¹æ€§æ–¹æ¡ˆã€‚

### é’ˆå¯¹æ€§æ–¹æ¡ˆ

> è¯¥æ–¹æ¡ˆå…¶å®å°±æ˜¯ç¼©å°æˆ‘ä»¬çš„æ„å»ºç›®æ ‡ï¼Œæ•´ä¸ªé¡¹ç›®è™½ç„¶æœ‰å¾ˆå¤šé¡µé¢ï¼Œä»ä¸Šé¢è·¯ç”±æ¥çœ‹å¤šè¾¾258ä¸ªï¼Œä½†æˆ‘ä»¬å¹³æ—¶åœ¨å¼€å‘è¿‡ç¨‹ä¸­å…¶å®åªå…³æ³¨æˆ‘ä»¬å½“å‰éœ€è¦ä¿®æ”¹çš„é¡µé¢ï¼Œæ‰€ä»¥æœ‰æ²¡æœ‰å¯èƒ½åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘åªæ„å»ºæˆ‘éœ€è¦ç”¨çš„é¡µé¢ï¼Œå¯¹äºé‚£äº›ä¸éœ€è¦çš„é¡µé¢ä¸å‚ä¸æ„å»ºï¼Œè¿™æ ·çš„è¯è‚¯å®šèƒ½å¤Ÿå¤§å¹…æå‡æˆ‘ä»¬çš„æœ¬åœ°æ„å»ºæ—¶é—´ã€‚

**è¿™é‡Œè¿˜éœ€è¦è€ƒè™‘çš„æ˜¯ï¼Œæ€ä¹ˆå¯¹åŸæœ‰æ„å»ºä»£ç çš„ä¾µå…¥æ€§åšåˆ°æœ€å°ï¼Ÿ**

#### æ€è·¯

- æ–°å¢æ„å»ºè„šæœ¬ï¼ŒåŸæœ‰`npm run dev`ä¿æŒä¸å˜
- å¤„ç†éœ€è¦å¯åŠ¨çš„é¡µé¢ï¼Œç”Ÿæˆå¯¹åº”çš„è·¯ç”±`routes.dev.js`
- æŠŠåŸæœ‰`routes`æå–æˆæ–‡ä»¶`routes.pro.js`
- å†é€šè¿‡`NormalModuleReplacementPlugin`æ’ä»¶åœ¨ç¼–è¯‘è¿‡ç¨‹è¿›è¡Œæ–‡ä»¶æ›¿æ¢
- æœ€åå†è¿›è¡Œæ„å»º

#### æ„å»ºè„šæœ¬

æ–°å¢startå‘½ä»¤

```json
// package.json
"start": "node ./build/cli.js start",
```

ä¸»è¦æ„å»ºä»£ç å¦‚ä¸‹

```js
// cli.js
const shell = require('shelljs')
const path = require('path')
const fs = require('fs')
const action = process.argv[2]
const arg = process.argv.slice(3)
let appName = arg[0]  // æŒ‡çš„æ˜¯ä½ è¦å¯åŠ¨çš„é¡¹ç›®ï¼ˆæ–‡ä»¶å¤¹åï¼‰
// const startPath = arg.join('/')
console.log('ğŸš€ğŸš€------start------ğŸš€ğŸš€')
;(() => {
  if (!appName) {
    // æœªè¾“å…¥é¡¹ç›®åç§°åˆ™å¼€å¯äº¤äº’å‘½ä»¤è¡Œ
    openInquirer()
    return
  }
  // å¯åŠ¨
  if (action === 'start') {
    start()
  }
})()

function start() {
  // console.log('å¯åŠ¨é¡¹ç›®')
  process.env.action = 'signle'
  runTask(appName)
}
// å¯åŠ¨é¡¹ç›®
async function runTask(appName) {
  const cmds = []
  console.log(`ğŸš¢ã€å¯åŠ¨é¡¹ç›®ã€‘${appName}`)
  generateRoute(appName) // ç”Ÿæˆéœ€è¦å¯åŠ¨çš„è·¯ç”±

  const runProPath = path.resolve(__dirname, `../src/pages/${appName}`)

  // if (process.platform === 'win32') {
  //   cmds.push(`set runProPath=${runProPath}`)
  // } else {
  //   cmds.push(`export runProPath=${runProPath}`)
  // }
  // æ£€æµ‹é¡¹ç›®æ˜¯å¦å­˜åœ¨
  const res = await getProject(runProPath)
  if (res.errno < 0) {
    // æŠ›å‡ºå¼‚å¸¸
    throw new Error('æ²¡æœ‰æ‰¾åˆ°å¯å¯åŠ¨çš„é¡¹ç›®ğŸ˜­')
  } else {
    cmds.push(`npx vue-cli-service serve --open --colors --mode dev`)
  }

  const cmd = cmds.join(' && ')
  // return
  const { code } = shell.exec(cmd)
  return code
}
```

#### å¤„ç†éœ€è¦å¯åŠ¨çš„é¡µé¢

ç”±äºè¿™ä¸ªé¡¹ç›®æ˜¯ç”¨`vue-auto-routing`æ¥è‡ªåŠ¨ç”Ÿæˆè·¯ç”±çš„ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä¾ç„¶è¿˜æ˜¯ç”¨å®ƒå†…éƒ¨çš„ä¸€ä¸ªåº“æ¥è‡ªåŠ¨ç”Ÿæˆ

```js
const { generateRoutes } = require('vue-route-generator')

// å¤„ç†éœ€è¦å¯åŠ¨çš„è·¯ç”±
function generateRoute() {
  console.log('--', path.resolve(__dirname, `../src/pages/${appName}/`))
  const code = generateRoutes({
    pages: path.resolve(__dirname, `../src/pages/${appName}/`),
    importPrefix: `@/pages/${appName}/`,
  })

  fs.writeFileSync(path.resolve(__dirname, `../src/routes.dev.js`), code)
}
```

#### æ›¿æ¢éœ€è¦å¯åŠ¨çš„è·¯ç”±

æ ¹æ®ç”¨æˆ·è¾“å…¥çš„éœ€è¦å¯åŠ¨çš„æ–‡ä»¶å¤¹åï¼Œæˆ‘ä»¬ä¸ºè¿™ä¸ªæ–‡ä»¶å¤¹å†…çš„æ‰€æœ‰æ–‡ä»¶è‡ªåŠ¨æˆäº†è·¯ç”±æ–‡ä»¶`routes.dev.js`ï¼Œç°åœ¨éœ€è¦åšçš„æ˜¯é€šè¿‡webpackè¿›è¡Œæ›¿æ¢ã€‚

```js
new webpack.NormalModuleReplacementPlugin(
    /src\/routes.pro.js/,
    './routes.dev.js',
  ),
```

#### ä½¿ç”¨

ä¸»è¦çš„å·¥ä½œå®Œæˆï¼Œç°åœ¨å¯ä»¥æ¥å¯åŠ¨è¯•ä¸€è¯•

æ¯”å¦‚ï¼šå¯åŠ¨æ ¡å›­ä¸“åŒºé¡¹ç›®

```shell
# å¯åŠ¨å‘½ä»¤ npm start + é¡¹ç›®åç§°ï¼ˆæ–‡ä»¶å¤¹åï¼‰
npm start campusArea
```

<img src="/Users/songyao/Library/Application Support/typora-user-images/image-20230526195506642.png" alt="image-20230526195506642" style="zoom:50%;" />

ç°åœ¨çš„å¯åŠ¨æ—¶é—´å¤§æ¦‚åœ¨15ç§’å·¦å³ï¼Œè¿™ä¸ä½ å½“å‰æ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶æ•°é‡æœ‰å…³ï¼Œæ–‡ä»¶è¶Šå°‘å¯åŠ¨è¶Šå¿«ï¼äºŒæ¬¡å¯åŠ¨æ—¶é—´å¤§æ¦‚åœ¨10ç§’å·¦å³ï¼Œå°é¡¹ç›®é¦–æ¬¡å¯åŠ¨æ—¶é•¿å¤§æ¦‚éƒ½åœ¨10ç§’å†…

**é¦–æ¬¡å†·å¯åŠ¨æ—¶é•¿å¤§æ¦‚èŠ‚çœäº†1minï¼Œå†™ä»£ç çš„æ—¶é—´åˆå˜å¤šäº†ğŸ˜‚**

#### ä¼˜åŒ–

å¯èƒ½å¤§å®¶éƒ½ä¹ æƒ¯äº†`npm run dev`æˆ–`npm start`ï¼Œä¼šå¿˜è®°å¯åŠ¨é¡µé¢çš„å‚æ•°ï¼Ÿ

ä¸è¦æ€¥ï¼Œè¿™ä¸€ç‚¹ä¹Ÿè€ƒè™‘è¿›å»äº†ï¼Œæœ‰ä¸ªéå¸¸å¼ºå¤§çš„åº“`inquirer`å¯ä»¥ä¸ºæˆ‘ä»¬å¼€å¯äº¤äº’å¼å‘½ä»¤è¡Œã€‚

```js
// æœªè¾“å…¥é¡¹ç›®åç§°åˆ™å¼€å¯äº¤äº’å‘½ä»¤è¡Œ
function openInquirer() {
  // è·å–æ‰€æœ‰å¯å¯åŠ¨ç›®å½•
  const projectList = fs.readdirSync(path.resolve(__dirname, '../src/pages'))
  // console.log('projectList', projectList)

  const promptList = [
    {
      type: 'list',
      message: 'ğŸš—è¯·é€‰æ‹©å¯åŠ¨çš„ç›®å½•:',
      name: 'pro',
      choices: [...projectList],
    },
  ]
  inquirer.prompt(promptList).then((answers) => {
    console.log(answers)
    appName = answers.pro
    start()
  })
}
```

å½“ä½ ç›´æ¥`npm start`çš„æ—¶å€™ï¼Œå¯ä»¥è®©ä½ é€‰æ‹©ä½ æƒ³è¦å¯åŠ¨çš„ç›®å½•ï¼š

![image-20230526200623001](/Users/songyao/Desktop/songyao/fe-nanjiu/images/0319/build-7.png)

ç»“æŸã€‚
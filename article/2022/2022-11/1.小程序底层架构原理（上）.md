## 为什么会诞生小程序？

2017 年 1 月 9 日 0 点：万众瞩目的微信第一批微信小程序正式低调上线，用户可以体验到各种各样微信小程序提供的服务。但是从某种意义上来说，微信小程序并不算是小程序理念的第一次提出。

早在2013 年 8 月 22 日，百度 CEO 李彦宏在百度世界大会上正式宣布推出**轻应用开放平台**，提出“移动搜索+轻应用”是满足海量**中长尾**应用开发者需求的最佳模式；以及2016 年 Google 提出的 PWA 的概念，于 2017 年正式落地，2018 年迎来重大突破，全球顶级的浏览器厂商，Google、Microsoft、Apple 已经全数宣布支持 PWA 技术，但是由于国内技术环境的特殊性，PWA 可算籍籍无名。

**轻应用、PWA都可谓是小程序界的先行者。**但最终在国内存活下来的只有微信推出的小程序。

### 发展历程

微信小程序的出现主要得益于自身用户流量的不断发展壮大，当微信中的 WebView 逐渐成为移动 Web 的一个重要入口时，微信就有相关的 JS API 了。

#### JS-SDK

2015年初，微信发布了一整套网页开发工具包，称之为`JS-SDK`，开放了拍摄、录音、语音识别、二维码、地图、支付、分享、卡券等几十个API。给所有的 Web 开发者打开了一扇全新的窗户，让所有开发者都可以使用到微信的原生能力，去完成一些之前做不到或者难以做到的事情。

#### Web 资源离线存储（没有对外开放）

虽然JS-SDK 解决了移动网页能力不足的问题，通过暴露微信的接口使得 Web 开发者能够拥有更多的能力，然而在更多的能力之外，JS-SDK 的模式并没有解决使用移动网页遇到的体验不良的问题。用户在访问网页的时候，在浏览器开始显示之前都会有一个白屏的过程，在移动端，受限于设备性能和网络速度，白屏会更加明显。

通过使用微信离线存储，Web 开发者可借助微信提供的资源存储能力，直接从微信本地加载 Web 资源而不需要再从服务端拉取，从而减少网页加载时间，为微信用户提供更优质的网页浏览体验。每个公众号下所有 Web App 累计最多可缓存 5M 的资源。

#### 小程序

为了使所有开发者在微信中都能获得比较好的体验，需要一个全新的系统来完成，它需要使得所有的开发者都能做到：

- 快速的加载
- 更强大的能力
- 原生的体验
- 易用且安全的微信数据开放
- 高效和简单的开发

这就是小程序的由来。

## 双线程架构

在这之前，我们先来思考一个问题，架构上为什么会选择双线程？

### 为什么是双线程？

#### 加载及渲染性能

从上面我们了解到，小程序的设计之初就是要求快速，这里的快速指的是加载以及渲染。

目前主流的渲染方式有以下3种：

- Web技术渲染
- Native技术渲染
- Hybrid技术渲染（同时使用了webview和原生来渲染）

因为微信小程序的宿主是微信，所以小程序不可能用原生来写，如果真这么做，那么小程序代码与微信代码一起编译，跟随微信发版，这种开发方式跟节奏必然是不对的。因此，我们需要向Web技术那样，有一份随时可更新的资源包放在云端，通过下载到本地，动态执行后即可渲染出界面。

**但如果用纯 Web 技术来渲染小程序，在一些有复杂交互的页面上可能会面临一些性能问题，这是因为在 Web 技术中，UI渲染跟 JavaScript 的脚本执行都在一个单线程中执行，这就容易导致一些逻辑任务抢占UI渲染的资源。**

因此微信小程序选择了Hybrid 技术，界面主要由成熟的 Web 技术渲染，辅之以大量的接口提供丰富的客户端原生能力。同时，每个小程序页面都是用不同的WebView去渲染，这样可以提供更好的交互体验，更贴近原生体验，也避免了单个WebView的任务过于繁重。

**微信小程序是以webview渲染为主，原生渲染为辅的混合渲染方式**

#### 管控安全

我们都知道基于web技术来渲染小程序，会存在一些不可控因素和安全风险。因为web技术非常灵活开放，我们可以使用Javascript去任意地控制页面的跳转或者改变页面上的任何内容，Javascript还可以通过操作DOM，直接获取小程序内部的一些敏感数据，比如用户信息等等，那么小程序将毫无安全可言。

为了解决安全管控的问题，小程序从设计上就阻止了开发者去使用一些浏览器提供的开放性api，比如说跳转页面、操作DOM等等。如果把这些东西一个一个地去加入到黑名单，那么势必会陷入一个非常糟糕的循环，因为浏览器的接口也非常丰富，那么就很容易遗漏一些危险的接口，而且就算是禁用掉了所有的接口，也防不住浏览器内核的下次更新。

所以要彻底解决这个问题，必须提供一个沙箱环境来运行开发者的`JavaScript` 代码。这个沙箱环境只提供纯 JavaScript 的解释执行环境，没有任何浏览器相关接口。那么像`HTML5`中的`ServiceWorker`、`WebWorker`特性就符合这样的条件，这两者都是启用另一线程来执行 `javaScript`。

这就是小程序双线程模型的由来：

- **渲染层：**界面渲染相关的任务全都在 WebView 线程里执行，通过逻辑层代码去控制渲染哪些界面。一个小程序存在多个界面，所以渲染层存在多个 WebView 线程。

- **逻辑层：**创建一个单独的线程去执行 JavaScript，在这个环境下执行的都是有关小程序业务逻辑的代码。

### 双线程模型

**小程序的架构模型有别与传统web单线程架构，小程序为双线程架构。**

微信小程序的渲染层与逻辑层分别由两个线程管理，渲染层的界面使用 `webview` 进行渲染；逻辑层采用 `JSCore`运行`JavaScript`代码。

![小程序双线程](/Users/songyao/Desktop/songyao/interview/images/22-11/小程序双线程.png)

### 双线程通信

从上图中我们可以看到，渲染层与逻辑层是无法直接进行通信的，两者之间的通信需要借助微信客户端Native来进行中转。

